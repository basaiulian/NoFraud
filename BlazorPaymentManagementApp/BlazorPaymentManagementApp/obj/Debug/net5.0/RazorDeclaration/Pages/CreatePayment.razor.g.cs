// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace BlazorPaymentManagementApp.Pages
{
    #line hidden
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\_Imports.razor"
using System.Net.Http.Json;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\_Imports.razor"
using Microsoft.AspNetCore.Components.Web.Virtualization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\_Imports.razor"
using Microsoft.AspNetCore.Components.WebAssembly.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\_Imports.razor"
using BlazorPaymentManagementApp;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\_Imports.razor"
using BlazorPaymentManagementApp.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\_Imports.razor"
using Blazored.LocalStorage;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\Pages\CreatePayment.razor"
using System.ComponentModel.DataAnnotations;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\Pages\CreatePayment.razor"
using BlazorPaymentManagementApp.Model;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\Pages\CreatePayment.razor"
using Newtonsoft.Json.Linq;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\Pages\CreatePayment.razor"
using System.Timers;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\Pages\CreatePayment.razor"
using System;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\Pages\CreatePayment.razor"
using Newtonsoft.Json;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.LayoutAttribute(typeof(CardLayout))]
    [Microsoft.AspNetCore.Components.RouteAttribute("/createpayment")]
    public partial class CreatePayment : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 91 "D:\Facultate\Anul III\[INET] Introducere in .NET\NOFRAUD\Versiune13.48-12.1.2021\BlazorPaymentManagementApp\BlazorPaymentManagementApp\Pages\CreatePayment.razor"
       [Required]
    [RegularExpression(@"^[0-9]+[.][0-9]+|[0-9]+$", ErrorMessage = "Amount must be like \"40\" or \"40.5\".")]
    public string AmountToSend { get; set; }

    private string countryToSend { get; set; }

    private string cityToSend { get; set; }

    private string latitudeToSend { get; set; }

    private string longitudeToSend { get; set; }

    [Required]
    public string cc_num { get; set; }

    private string message2 = "";

    private string message = "";

    private string safeStatus = "Not Safe";

    private List<string> currencyList = new List<string>()
{
       "RON",
       "EUR",
       "GBP",
       "USD"
    };

    private User user = new User();

    private List<User> users = new List<User>();

    private string destinationUserState;

    private string destinationUserCity;

    private string destinationUserId;

    private double distance;

    private Timer aTimer;

    public string localId { get; set; }

    public string prediction { get; set; }

    private List<Address> countries = new List<Address>();

    private List<string> creditCardNumbers = new List<string>();

    private List<string> countryList = new List<string>();

    private List<string> cityList = new List<string>();

    private Payment payment = new Payment();

    private Payment lastPayment = new Payment();

    private List<Payment> payments;

    HttpClient httpClient = new HttpClient()
    {
        BaseAddress = new Uri("http://localhost:5000")
    };

    HttpClient predictorHttpClient = new HttpClient()
    {
        BaseAddress = new Uri("http://localhost:5020")
    };

    protected void getCities()
    {
        cityList.Clear();

        foreach (Address address in countries)
        {
            if (address.Country == countryToSend)
            {
                if (!cityList.Contains(address.City))
                {
                    cityList.Add(address.City);
                }
            }
        }
    }

    protected List<string> getCoordinates(string country, string city)
    {
        foreach (Address address in countries)
        {
            if (address.Country == country && address.City == city && city != "City")
            {
                latitudeToSend = address.Latitude;
                longitudeToSend = address.Longitude;
            }
            if (city == "City")
            {
                latitudeToSend = "-1";
                longitudeToSend = "-1";
                break;
            }
        }
        return new List<string> { latitudeToSend, longitudeToSend };
    }

    protected async Task<string>
    GenerateId(int length)
    {
        string cypher = "123456789";

        var random = new Random();

        string generatedId = "";

        for (int i = 0; i < length; i++)
        {
            generatedId += cypher[random.Next(cypher.Length)];
        }

        return generatedId;
    }

    protected async Task Create()
    {
        List<string> destinationCoordinates = new List<string>();
        List<string> sourceCoordinates = new List<string>();

        payment.Source = user.Username;
        payment.Date = DateTime.Now;
        payment.Amount = Convert.ToSingle(AmountToSend);


        users = await httpClient.GetFromJsonAsync<List<User>>("/api/v1/users");

        if (countryToSend == null || cityToSend == null || countryToSend == "Country" || cityToSend == "City")
        {
            message = "Please insert the payment source (Country and City)!";
        }
        else
        {
            message = "";
            HttpResponseMessage distanceResult = new HttpResponseMessage();
            if (cc_num != "Credit Card Number")
            {

                foreach (User user in users)
                {
                    if (payment.Destination == user.Username)
                    {
                        destinationUserState = user.Address.Substring(0, user.Address.IndexOf(',')).Trim();
                        destinationUserCity = user.Address.Substring(user.Address.LastIndexOf(',') + 1).Trim();
                        destinationCoordinates = getCoordinates(destinationUserState, destinationUserCity);
                        destinationUserId = user.Id.ToString();
                    }
                    else
                    {
                        message = "Please insert the payment destination (Username)!";
                    }
                }

                sourceCoordinates = getCoordinates(countryToSend, cityToSend);

                if ((sourceCoordinates[0] == "-1" && sourceCoordinates[1] == "-1") || (destinationCoordinates[0] == "-1" && destinationCoordinates[1] == "-1"))
                {
                    Console.WriteLine("EROARE -1");
                }
                else
                {
                    message = "";
                    distanceResult = await httpClient.PostAsJsonAsync<List<List<string>>>("/api/v1/payments/distance", new List<List<string>> { sourceCoordinates, destinationCoordinates });
                }
            }

            var Trans_date_trans_time = DateTime.Now;
            var First = user.Username;
            var Trans_distance = distanceResult.Content.ReadAsStringAsync().Result;

            if (payment.Currency == "EUR")
            {
                payment.Amount = float.Parse(AmountToSend) * 4.87F;
            }
            else if (payment.Currency == "USD")
            {
                payment.Amount = float.Parse(AmountToSend) * 4.00F;
            }
            else if (payment.Currency == "GBP")
            {
                payment.Amount = float.Parse(AmountToSend) * 5.48F;
            }

            List<String> listToPredict = new List<String> { Trans_date_trans_time.ToShortDateString(), cc_num, AmountToSend, First, Trans_distance.ToString() };

            if ((Trans_date_trans_time - lastPayment.Date).Hours > 8 && float.Parse(Trans_distance) > 3100F)
            {
                prediction = "1";
                message2 = "The payment is not safe.";
                safeStatus = "Not Safe";
            }
            else
            {
                var predict_response = await predictorHttpClient.PostAsJsonAsync<List<string>>("/fraud/index", listToPredict);
                string returnValue = await predict_response.Content.ReadAsStringAsync();

                JObject jObject = JObject.Parse(returnValue);
                prediction = jObject["prediction"].ToString();

                if (prediction == "0")
                {

                    List<string> transferData = new List<string> { payment.Amount.ToString(), localId, destinationUserId };
                    var transferResult = await httpClient.PostAsJsonAsync<List<string>>("/api/v1/bankaccounts/transfer", transferData);

                    if (transferResult.Content.ReadAsStringAsync().Result == "-1")
                    {
                        message = "Insufficient balance";
                        return;
                    }
                    else
                    {
                        message = "";
                        message2 = "The payment is safe.";
                        safeStatus = "Safe";
                    }
                }
                else if (prediction == "1")
                {
                    message = "The payment is not safe. Payment blocked.";
                    safeStatus = "Not Safe";
                }
            }

            payment.IsFraud = safeStatus;
            payment.Id = Int32.Parse(await GenerateId(4));
            payment.Amount = Convert.ToSingle(AmountToSend);

            await httpClient.PostAsJsonAsync<Payment>("/api/v1/payments", payment);

            payment.Id = Int32.Parse(await GenerateId(4));
            payment.IsFraud = "Received";
            var destination = payment.Destination;
            var source = payment.Source;
            payment.Source = destination;
            payment.Destination = source;

            await httpClient.PostAsJsonAsync<Payment>("/api/v1/payments", payment);

            aTimer = new Timer();
            aTimer.Interval = 2000;

            // Hook up the Elapsed event for the timer.
            aTimer.Elapsed += (sender, args) =>
            {
                NavManager.NavigateTo("/users/" + localId, true);
            };

            // Have the timer fire repeated events (true is the default)
            aTimer.AutoReset = true;

            // Start the timer
            aTimer.Enabled = true;
        }

    }

    protected override async Task OnInitializedAsync()
    {

        countries = await httpClient.GetFromJsonAsync<List<Address>>("/api/v1/payments/countries");

        foreach (Address address in countries)
        {
            if (!countryList.Contains(address.Country))
            {
                countryList.Add(address.Country);
            }
        }

        foreach (string country in countryList)
        {
            Console.WriteLine(country);
        }

        localId = await localStorage.GetItemAsStringAsync("id");
        user = await httpClient.GetFromJsonAsync<User>("/api/v1/users/" + localId);
        foreach (BankAccount bankAccount in user.BankAccounts)
        {
            foreach (Card card in bankAccount.CardList)
            {
                if (!creditCardNumbers.Contains(card.Number))
                {
                    creditCardNumbers.Add(card.Number);
                }
            }
        }

        payments = await httpClient.GetFromJsonAsync<List<Payment>>("/api/v1/payments");

        foreach (Payment payment in payments)
        {
            if (payment.Source == user.Username)
            {
                lastPayment = payment;
            }
        }
    } 

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IJSRuntime JsRuntime { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private NavigationManager NavManager { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private Blazored.LocalStorage.ILocalStorageService localStorage { get; set; }
    }
}
#pragma warning restore 1591
